<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEEKLY SHIPSTATION LEADERBOARD</title>
  <style>
    :root{
      --header-grad: linear-gradient(90deg,#0a5d42,#2d9c6f);
      --bg-start:#0f1720;
      --bg-end:#1b2730;
      --ft:#34a853;
      --pt:#4285f4;
      --wh:#f57c00;
      --gold:#ffd700;
      --silver:#c0c0c0;
      --bronze:#cd7f32;
      --row-light:#f8f9fa;
      --row-dark:#eef1f3;
      --card-bg: rgba(255,255,255,0.98);
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:linear-gradient(180deg,var(--bg-start),var(--bg-end));color:#111;}
    .wrap{max-width:95%;margin:18px auto;padding:18px;}
    
    /* Header */
    .header{
      display:flex;align-items:center;gap:16px;padding:16px;border-radius:10px;background:var(--header-grad);box-shadow:0 8px 24px rgba(5,10,10,0.45);color:white;
    }
    .header-center{flex:1;text-align:center}
    .title{font-weight:800;letter-spacing:1.5px;font-size:44px;margin:0;padding:0;text-transform:capitalize}
    .meta{font-size:26px;color:rgba(255,255,255,0.95);margin-top:10px;font-weight:600}

    /* Boards */
    .boards{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:22px}
    .card{
      background:var(--card-bg);
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(2,6,10,0.35), 0 20px 60px rgba(0,0,0,0.6);
      display:flex;
      flex-direction:column;
      height:calc(100vh - 220px);
      min-height:700px;
    }
    .card-head{padding:18px 14px;color:#fff;font-weight:700;text-align:center;font-size:22px}
    .card-body{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0;background:#2a2f3a}
    table{width:100%;border-collapse:collapse;font-size:17px;table-layout:fixed;min-width:100%}
    thead{display:table;width:100%;table-layout:fixed}
    thead tr{display:table-row}
    thead th{padding:16px 10px;text-align:center;font-weight:700;color:white;position:sticky;top:0;z-index:2;background:#1a1f28;font-size:18px;white-space:nowrap}
    tbody{display:block;width:100%;table-layout:fixed}
    tbody tr{display:table;width:100%;table-layout:fixed;color:#fff}
    td{padding:16px 10px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:middle;font-size:17px;white-space:nowrap}
    
    /* Remove border from medal rows */
    .medal-gold td, .medal-silver td, .medal-bronze td{border-bottom:none}
    .col-rank{font-size:20px;font-weight:700;width:60px}
    .col-employee{
      text-align:left;
      padding-left:16px;
      padding-right:16px;
      font-size:18px;
      font-weight:600;
      white-space:nowrap;
      width:40%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .col-prod{font-size:18px;font-weight:600;width:15%}
    .col-orders{font-size:18px;font-weight:600;width:15%}
    .col-avg{font-size:18px;font-weight:600;width:15%}

    /* row shading */
    tbody tr:nth-child(odd) td{background:#353b47}
    tbody tr:nth-child(even) td{background:#2e343f}

    /* medals - highlight entire row */
    .medal-gold td{background:var(--gold) !important;color:#000;font-weight:700}
    .medal-silver td{background:var(--silver) !important;color:#000;font-weight:700}
    .medal-bronze td{background:var(--bronze) !important;color:#000;font-weight:700}

    /* empty state */
    .empty{color:#b0b5bd;padding:20px;text-align:center;font-style:italic}

    /* responsive */
    @media (max-width:1100px){
      .boards{grid-template-columns:1fr;}
      .card{height:600px;margin-bottom:15px}
      .col-employee{width:auto}
    }
    
    @media (max-width:768px){
      body{padding:10px;}
      .wrap{padding:10px;margin:10px auto;}
      
      .header{padding:20px;gap:10px;}
      .title{font-size:24px;letter-spacing:0.5px}
      .meta{font-size:16px;}
      
      .boards{gap:12px;margin-top:12px}
      .card{height:500px;}
      .card-head{padding:10px;font-size:14px;}
      
      table{font-size:11px}
      thead th{padding:8px 4px;font-size:11px}
      td{padding:8px 4px;}
      
      .col-rank{width:45px;font-size:11px}
      .col-employee{font-size:11px;padding-left:6px;white-space:normal;word-break:break-word}
      .col-prod{width:70px;font-size:10px}
      .col-orders{width:65px;font-size:10px}
      .col-avg{width:85px;font-size:10px}
    }
    
    @media (max-width:480px){
      .title{font-size:20px;}
      .meta{font-size:14px;}
      
      .card{height:450px;}
      .card-head{font-size:12px;padding:8px;}
      
      table{font-size:10px}
      thead th{padding:6px 3px;font-size:10px}
      td{padding:6px 3px;}
      
      .col-rank{width:40px;font-size:10px}
      .col-employee{font-size:10px;padding-left:4px}
      .col-prod{width:60px;font-size:9px}
      .col-orders{width:55px;font-size:9px}
      .col-avg{width:75px;font-size:9px}
    }

    /* scrolling wrapper */
    .scroll-wrapper{position:relative;flex:1;overflow:hidden;display:flex;flex-direction:column}
    .scroll-content{position:relative;width:100%;overflow:hidden;flex-shrink:0}
    .scroll-content table{margin:0;width:100%;height:auto}
    .fade-top,.fade-bottom{position:absolute;left:0;right:0;height:36px;pointer-events:none}
    .fade-top{top:0;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0));}
    .fade-bottom{bottom:0;background:linear-gradient(0deg,rgba(255,255,255,0.98),rgba(255,255,255,0));}

    .notice{grid-column:1/-1;padding:12px;border-radius:8px;background:rgba(255,255,255,0.04);color:#fff;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header" role="banner">
      <div style="width:56px"></div>
      <div class="header-center">
        <div class="title">Today's Shipstation Leaderboard</div>
        <div id="weekRange" class="meta">Week: loading…</div>
      </div>
      <div style="width:56px"></div>
    </div>

    <div id="boards" class="boards" aria-live="polite" style="margin-top:18px">
      <div class="notice">Loading data...</div>
    </div>
  </div>
  
  <div id="debug" style="display:none"></div>

<script>
(async function(){
  const SHEET_ID = '1HYfTADTvqpOMByLHcNPrgu8ahY58AZmdxaVgKbfQlMQ';
  const GID = '1113265790';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
  
  const debugEl = document.getElementById('debug');
  function log(msg, isError = false){
    console.log(msg);
    if(debugEl){
      debugEl.classList.add('show');
      debugEl.innerHTML += `<div style="color:${isError?'#f00':'#0f0'}">${new Date().toLocaleTimeString()}: ${msg}</div>`;
    }
  }

  log(`Starting load from: ${CSV_URL}`);

  function parseCSV(text){
    const rows = [];
    const lines = text.replace(/\r\n/g,'\n').split('\n');
    for(const line of lines){
      const row = [];
      let cur = '';
      let inQuotes = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"' ){
          if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
          inQuotes = !inQuotes;
          continue;
        }
        if(ch === ',' && !inQuotes){
          row.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  async function fetchCSV(){
    log('Fetching CSV...');
    const res = await fetch(CSV_URL);
    log(`Fetch response status: ${res.status}`);
    if(!res.ok) throw new Error('Failed to load sheet — make sure it is published. Status: '+res.status);
    const txt = await res.text();
    log(`Received ${txt.length} characters`);
    return parseCSV(txt);
  }

  function findMeta(grid){
    for(let r=0;r<8 && r<grid.length;r++){
      const text = (grid[r] || []).join(' ').trim();
      if(!text) continue;
      if(/week[:\s]/i.test(text) || /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i.test(text)){
        return {row:r, text};
      }
    }
    return null;
  }
  
  function findLastUpdated(grid){
    for(let r=0;r<8 && r<grid.length;r++){
      const text = (grid[r] || []).join(' ').trim();
      if(/last updated/i.test(text)) return {row:r, text};
    }
    return null;
  }

  function findRankHeaders(grid){
    const headers = [];
    for(let r=0;r<12 && r<grid.length;r++){
      for(let c=0;c<(grid[r]||[]).length;c++){
        const cell = ((grid[r]||[])[c]||'').toString().trim().toLowerCase();
        if(cell === 'rank') headers.push({row:r,col:c});
      }
    }
    return headers;
  }

  function extractBlock(grid, header){
    const out = [];
    const start = header.row + 1;
    const col = header.col;
    let empties = 0;
    for(let r=start;r<grid.length;r++){
      const row = grid[r] || [];
      const rank = (row[col] || '').toString().trim();
      const employee = (row[col+1] || '').toString().trim();
      const products = (row[col+2] || '').toString().trim();
      const orders = (row[col+3] || '').toString().trim();
      const avg = (row[col+4] || '').toString().trim();
      if(!rank && !employee && !products && !orders && !avg){ 
        empties++; 
        if(empties>=3) break; 
        else continue; 
      }
      out.push({rank, employee, products, orders, avg});
    }
    return out;
  }

  function nice(x){ 
    if(!x) return ''; 
    const n = Number(x.toString().replace(/[,]/g,'')); 
    return Number.isFinite(n) ? n.toLocaleString() : x; 
  }

  function buildCard(title,color,rows){
    const head = `<div class="card-head" style="background:${color}">${title.toUpperCase()}</div>`;
    if(!rows || rows.length===0) return `<div class="card">${head}<div class="card-body"><div class="empty">No data for this week</div></div></div>`;
    const rowsHtml = rows.map((r,idx)=>{
      const cls = idx===0? 'medal-gold' : idx===1? 'medal-silver' : idx===2? 'medal-bronze' : '';
      const displayRank = (idx + 1).toString();
      // Split name by space and join with newline so first/last names stay on separate lines
      const employeeName = (r.employee || '').replace(/\s+/g, '\n');
      return `<tr class="${cls}"><td class="col-rank">${displayRank}</td><td class="col-employee">${employeeName}</td><td class="col-prod">${nice(r.products)}</td><td class="col-orders">${nice(r.orders)}</td><td class="col-avg">${r.avg||''}</td></tr>`;
    }).join('');
    return `
      <div class="card">
        ${head}
        <div class="card-body">
          <div class="table-container">
            <table aria-label="${title} leaderboard">
              <thead>
                <tr>
                  <th class="col-rank">Rank</th>
                  <th class="col-employee">Employee</th>
                  <th class="col-prod">Products</th>
                  <th class="col-orders">Orders</th>
                  <th class="col-avg">Avg Item/Order</th>
                </tr>
              </thead>
            </table>
            <div class="scroll-wrapper" data-rows="${rows.length}" style="flex:1;position:relative">
              <div class="scroll-content" role="list" aria-label="${title} entries">
                <table><tbody>${rowsHtml}</tbody></table>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  try{
    const raw = await fetchCSV();
    log(`Parsed ${raw.length} rows`);
    
    const meta = findMeta(raw);
    if(meta) {
      document.getElementById('weekRange').textContent = meta.text.replace(/\s{2,}/g,' ').trim();
      log(`Found meta: ${meta.text}`);
    }
    
    const lu = findLastUpdated(raw);
    if(lu) {
      log(`Found last updated: ${lu.text}`);
    }

    const headers = findRankHeaders(raw);
    log(`Found ${headers.length} rank headers at: ${JSON.stringify(headers)}`);
    
    let chosen = headers.slice(0,3);
    if(chosen.length < 3){
      log('Using fallback header positions');
      const fallback = [{row:3,col:1},{row:3,col:7},{row:3,col:13}];
      chosen = fallback.slice(0,3);
    }

    chosen.sort((a,b)=>a.col - b.col);

    const cats = ['Full-time','Part-Time','Wholesale'];
    const cols = {'Full-time':'var(--ft)','Part-Time':'var(--pt)','Wholesale':'var(--wh)'};
    const boards = document.getElementById('boards');
    boards.innerHTML = '';

    for(let i=0;i<3;i++){
      const h = chosen[i];
      const rows = h ? extractBlock(raw,h) : [];
      log(`${cats[i]}: extracted ${rows.length} rows from col ${h.col}`);
      boards.insertAdjacentHTML('beforeend', buildCard(cats[i], cols[cats[i]], rows));
    }

    document.querySelectorAll('.scroll-wrapper').forEach(wrapper=>{
      const content = wrapper.querySelector('.scroll-content');
      const inner = content.querySelector('tbody');
      setTimeout(()=>{
        const contentH = inner.scrollHeight;
        const wrapH = wrapper.clientHeight;
        if(contentH > wrapH){
          // Position at top initially
          content.style.position = 'absolute';
          content.style.top = '0';
          content.style.left = '0';
          content.style.right = '0';
          
          let pos = 0;
          const scrollDistance = contentH - wrapH;
          const speed = 30;
          let direction = 1;
          let last = performance.now();
          let pauseUntil = 0;
          
          function step(now){
            // Check if we're in pause period
            if(pauseUntil > 0 && now < pauseUntil){
              requestAnimationFrame(step);
              return;
            }
            
            // Resume after pause - reset last timestamp
            if(pauseUntil > 0 && now >= pauseUntil){
              pauseUntil = 0;
              last = now;
            }
            
            const delta = now - last;
            last = now;
            pos += (speed * delta / 1000) * direction;
            
            // Reached bottom - pause then reverse
            if(pos >= scrollDistance){
              pos = scrollDistance;
              direction = -1;
              pauseUntil = now + 2000;
            }
            // Reached top - pause then go down
            else if(pos <= 0){
              pos = 0;
              direction = 1;
              pauseUntil = now + 2000;
            }
            
            inner.style.transform = `translateY(${-pos}px)`;
            requestAnimationFrame(step);
          }
          requestAnimationFrame(step);
        } else {
          // If content fits, position at top (no centering)
          content.style.position = 'relative';
          inner.style.marginTop = '0px';
        }
      },120);
    });

    log('✓ Dashboard loaded successfully!');

  } catch(err){
    log(`ERROR: ${err.message}`, true);
    console.error(err);
    document.getElementById('boards').innerHTML = `<div class="notice">⚠️ Error loading data: ${err.message}<br><br>Troubleshooting steps:<br>1. Make sure the Google Sheet is published (File → Share → Publish to web)<br>2. Select "Entire Document" or the specific sheet<br>3. Choose "Web page" format<br>4. Click Publish</div>`;
  }
})();
</script>
</body>
</html>
