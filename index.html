<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEEKLY SHIPSTATION LEADERBOARD</title>
  <style>
    :root{
      --header-grad: linear-gradient(90deg,#0B6E4F,#34a853);
      --bg-start:#0f1720;
      --bg-end:#1b2730;
      --ft:#34a853;
      --pt:#4285f4;
      --wh:#f57c00;
      --gold:#ffd700;
      --silver:#c0c0c0;
      --bronze:#cd7f32;
      --row-light:#f8f9fa;
      --row-dark:#eef1f3;
      --card-bg: rgba(255,255,255,0.98);
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:linear-gradient(180deg,var(--bg-start),var(--bg-end));color:#111;}
    .wrap{max-width:1600px;margin:18px auto;padding:18px;}
    
    /* Header */
    .header{
      display:flex;align-items:center;gap:16px;padding:16px;border-radius:10px;background:var(--header-grad);box-shadow:0 8px 24px rgba(5,10,10,0.45);color:white;
    }
    .header-center{flex:1;text-align:center}
    .title{font-weight:800;letter-spacing:1px;font-size:20px;margin:0;padding:0}
    .meta{font-size:13px;color:rgba(255,255,255,0.95);margin-top:6px}
    .submeta{font-size:12px;color:rgba(255,255,255,0.8);margin-top:4px}

    /* Boards */
    .boards{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px}
    .card{background:var(--card-bg);border-radius:10px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,10,0.35);display:flex;flex-direction:column;height:650px}
    .card-head{padding:12px 14px;color:#fff;font-weight:700;text-align:center}
    .card-body{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:8px}
    table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:13px}
    thead th{padding:10px 8px;text-align:center;font-weight:700;color:white;position:sticky;top:0;z-index:2}
    tbody{display:block;width:100%;overflow:hidden}
    tbody tr{display:table;width:100%;table-layout:fixed}
    td{padding:10px 8px;text-align:center;border-bottom:1px solid rgba(16,22,26,0.05);vertical-align:middle;word-break:break-word}
    .col-rank{width:68px}
    .col-employee{width:320px;text-align:left;padding-left:12px}
    .col-prod{width:120px}
    .col-orders{width:100px}
    .col-avg{width:110px}

    /* row shading */
    tbody tr:nth-child(odd) td{background:var(--row-light)}
    tbody tr:nth-child(even) td{background:var(--row-dark)}

    /* medals - highlight entire row */
    .medal-gold td{background:var(--gold) !important;color:#000;font-weight:700}
    .medal-silver td{background:var(--silver) !important;color:#000;font-weight:700}
    .medal-bronze td{background:var(--bronze) !important;color:#000;font-weight:700}

    /* empty state */
    .empty{color:#8a8f98;padding:20px;text-align:center;font-style:italic}

    /* responsive */
    @media (max-width:1100px){.boards{grid-template-columns:1fr;}.col-employee{width:45vw} .card{height:600px}}

    /* scrolling wrapper */
    .scroll-wrapper{position:relative;flex:1;overflow:hidden}
    .scroll-content{position:absolute;left:0;right:0;top:0}
    .scroll-content table{margin:0}
    .scroll-content tbody{display:block}
    .fade-top,.fade-bottom{position:absolute;left:0;right:0;height:36px;pointer-events:none}
    .fade-top{top:0;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0));}
    .fade-bottom{bottom:0;background:linear-gradient(0deg,rgba(255,255,255,0.98),rgba(255,255,255,0));}

    .notice{grid-column:1/-1;padding:12px;border-radius:8px;background:rgba(255,255,255,0.04);color:#fff;text-align:center}
    

  </style>
</head>
<body>
  <div class="wrap">
    <div class="header" role="banner">
      <div style="width:56px"></div>
      <div class="header-center">
        <div class="title">WEEKLY SHIPSTATION LEADERBOARD</div>
        <div id="weekRange" class="meta">Week: loading‚Ä¶</div>
        <div id="lastUpdated" class="submeta">Last Updated: ‚Äî</div>
      </div>
      <div style="width:56px"></div>
    </div>

    <div id="boards" class="boards" aria-live="polite" style="margin-top:18px">
      <div class="notice">Loading data...</div>
    </div>
  </div>
  
  <div id="debug" style="display:none"></div>

<script>
(async function(){
  const SHEET_ID = '1HYfTADTvqpOMByLHcNPrgu8ahY58AZmdxaVgKbfQlMQ';
  const GID = '1113265790';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
  
  // Debug logger
  const debugEl = document.getElementById('debug');
  function log(msg, isError = false){
    console.log(msg);
    if(debugEl){
      debugEl.classList.add('show');
      debugEl.innerHTML += `<div style="color:${isError?'#f00':'#0f0'}">${new Date().toLocaleTimeString()}: ${msg}</div>`;
    }
  }

  log(`Starting load from: ${CSV_URL}`);

  function parseCSV(text){
    const rows = [];
    const lines = text.replace(/\r\n/g,'\n').split('\n');
    for(const line of lines){
      const row = [];
      let cur = '';
      let inQuotes = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"' ){
          if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
          inQuotes = !inQuotes;
          continue;
        }
        if(ch === ',' && !inQuotes){
          row.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  async function fetchCSV(){
    log('Fetching CSV...');
    const res = await fetch(CSV_URL);
    log(`Fetch response status: ${res.status}`);
    if(!res.ok) throw new Error('Failed to load sheet ‚Äî make sure it is published. Status: '+res.status);
    const txt = await res.text();
    log(`Received ${txt.length} characters`);
    return parseCSV(txt);
  }

  function findMeta(grid){
    for(let r=0;r<8 && r<grid.length;r++){
      const text = (grid[r] || []).join(' ').trim();
      if(!text) continue;
      if(/week[:\s]/i.test(text) || /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i.test(text)){
        return {row:r, text};
      }
    }
    return null;
  }
  
  function findLastUpdated(grid){
    for(let r=0;r<8 && r<grid.length;r++){
      const text = (grid[r] || []).join(' ').trim();
      if(/last updated/i.test(text)) return {row:r, text};
    }
    return null;
  }

  function findRankHeaders(grid){
    const headers = [];
    for(let r=0;r<12 && r<grid.length;r++){
      for(let c=0;c<(grid[r]||[]).length;c++){
        const cell = ((grid[r]||[])[c]||'').toString().trim().toLowerCase();
        if(cell === 'rank') headers.push({row:r,col:c});
      }
    }
    return headers;
  }

  function extractBlock(grid, header){
    const out = [];
    const start = header.row + 1;
    const col = header.col;
    let empties = 0;
    for(let r=start;r<grid.length;r++){
      const row = grid[r] || [];
      const rank = (row[col] || '').toString().trim();
      const employee = (row[col+1] || '').toString().trim();
      const products = (row[col+2] || '').toString().trim();
      const orders = (row[col+3] || '').toString().trim();
      const avg = (row[col+4] || '').toString().trim();
      if(!rank && !employee && !products && !orders && !avg){ 
        empties++; 
        if(empties>=3) break; 
        else continue; 
      }
      out.push({rank, employee, products, orders, avg});
    }
    return out;
  }

  function nice(x){ 
    if(!x) return ''; 
    const n = Number(x.toString().replace(/[,]/g,'')); 
    return Number.isFinite(n) ? n.toLocaleString() : x; 
  }

  function buildCard(title,color,rows){
    const head = `<div class="card-head" style="background:${color}">üèÜ ${title.toUpperCase()} üèÜ</div>`;
    if(!rows || rows.length===0) return `<div class="card">${head}<div class="card-body"><div class="empty">No data for this week</div></div></div>`;
    const rowsHtml = rows.map((r,idx)=>{
      const cls = idx===0? 'medal-gold' : idx===1? 'medal-silver' : idx===2? 'medal-bronze' : '';
      return `<tr class="${cls}"><td class="col-rank">${r.rank||''}</td><td class="col-employee">${r.employee||''}</td><td class="col-prod">${nice(r.products)}</td><td class="col-orders">${nice(r.orders)}</td><td class="col-avg">${r.avg||''}</td></tr>`;
    }).join('');
    return `
      <div class="card">
        ${head}
        <div class="card-body">
          <div style="overflow:hidden;flex:1;display:flex;flex-direction:column">
            <table aria-label="${title} leaderboard">
              <thead><tr><th class="col-rank">Rank</th><th class="col-employee">Employee</th><th class="col-prod">Products</th><th class="col-orders">Orders</th><th class="col-avg">Avg/Order</th></tr></thead>
            </table>
            <div class="scroll-wrapper" data-rows="${rows.length}" style="flex:1;position:relative">
              <div class="scroll-content" role="list" aria-label="${title} entries">
                <table><tbody>${rowsHtml}</tbody></table>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  try{
    const raw = await fetchCSV();
    log(`Parsed ${raw.length} rows`);
    
    const meta = findMeta(raw);
    if(meta) {
      document.getElementById('weekRange').textContent = meta.text.replace(/\s{2,}/g,' ').trim();
      log(`Found meta: ${meta.text}`);
    }
    
    const lu = findLastUpdated(raw);
    if(lu) {
      document.getElementById('lastUpdated').textContent = lu.text.replace(/\s{2,}/g,' ').trim();
      log(`Found last updated: ${lu.text}`);
    }

    const headers = findRankHeaders(raw);
    log(`Found ${headers.length} rank headers at: ${JSON.stringify(headers)}`);
    
    let chosen = headers.slice(0,3);
    if(chosen.length < 3){
      log('Using fallback header positions');
      const fallback = [{row:3,col:1},{row:3,col:7},{row:3,col:13}];
      chosen = fallback.slice(0,3);
    }

    chosen.sort((a,b)=>a.col - b.col);

    const cats = ['Full-time','Part-Time','Wholesale'];
    const cols = {'Full-time':'var(--ft)','Part-Time':'var(--pt)','Wholesale':'var(--wh)'};
    const boards = document.getElementById('boards');
    boards.innerHTML = '';

    for(let i=0;i<3;i++){
      const h = chosen[i];
      const rows = h ? extractBlock(raw,h) : [];
      log(`${cats[i]}: extracted ${rows.length} rows from col ${h.col}`);
      boards.insertAdjacentHTML('beforeend', buildCard(cats[i], cols[cats[i]], rows));
    }

    // scrolling animation - scroll down then back up
    document.querySelectorAll('.scroll-wrapper').forEach(wrapper=>{
      const content = wrapper.querySelector('.scroll-content');
      const inner = content.querySelector('table');
      setTimeout(()=>{
        const contentH = inner.scrollHeight;
        const wrapH = wrapper.clientHeight;
        if(contentH > wrapH){
          let pos = 0;
          const scrollDistance = contentH - wrapH;
          const speed = 30; // px/sec
          let direction = 1; // 1 = down, -1 = up
          let raf = null;
          let last = performance.now();
          let pauseUntil = 0;
          
          function step(now){
            // Pause at top and bottom
            if(now < pauseUntil){
              raf = requestAnimationFrame(step);
              return;
            }
            
            const delta = now - last;
            last = now;
            pos += (speed * delta / 1000) * direction;
            
            // Reached bottom, pause then reverse
            if(pos >= scrollDistance){
              pos = scrollDistance;
              direction = -1;
              pauseUntil = now + 2000; // pause 2 seconds at bottom
            }
            // Reached top, pause then go down
            else if(pos <= 0){
              pos = 0;
              direction = 1;
              pauseUntil = now + 2000; // pause 2 seconds at top
            }
            
            content.style.transform = `translateY(${-pos}px)`;
            raf = requestAnimationFrame(step);
          }
          raf = requestAnimationFrame(step);
          wrapper.addEventListener('mouseenter', ()=>{ if(raf) cancelAnimationFrame(raf); raf = null; });
          wrapper.addEventListener('mouseleave', ()=>{ if(!raf){ last = performance.now(); raf = requestAnimationFrame(step); } });
        } else {
          inner.style.marginTop = Math.max(0, (wrapH - contentH)/2) + 'px';
        }
      },120);
    });

    log('‚úì Dashboard loaded successfully!');
    // Debug panel is now hidden permanently

  } catch(err){
    log(`ERROR: ${err.message}`, true);
    console.error(err);
    document.getElementById('boards').innerHTML = `<div class="notice">‚ö†Ô∏è Error loading data: ${err.message}<br><br>Troubleshooting steps:<br>1. Make sure the Google Sheet is published (File ‚Üí Share ‚Üí Publish to web)<br>2. Select "Entire Document" or the specific sheet<br>3. Choose "Web page" format<br>4. Click Publish</div>`;
  }
})();
</script>
</body>
</html>
