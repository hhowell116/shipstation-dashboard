<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEEKLY SHIPSTATION LEADERBOARD</title>
  <style>
    :root{
      --header-grad: linear-gradient(90deg,#0B6E4F,#34a853);
      --bg-start:#0f1720;
      --bg-end:#1b2730;
      --ft:#34a853;
      --pt:#4285f4;
      --wh:#f57c00;
      --gold:#ffd700;
      --silver:#c0c0c0;
      --bronze:#cd7f32;
      --row-light:#f8f9fa;
      --row-dark:#eef1f3;
      --card-bg: rgba(255,255,255,0.98);
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:linear-gradient(180deg,var(--bg-start),var(--bg-end));color:#111;}
    .wrap{max-width:1400px;margin:18px auto;padding:18px;}
    /* Header */
    .header{
      display:flex;align-items:center;gap:16px;padding:14px 18px;border-radius:10px;background:var(--header-grad);box-shadow:0 8px 24px rgba(5,10,10,0.45);color:white;
    }
    .logo{height:56px;width:56px;flex:0 0 56px;border-radius:6px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .logo img{height:48px; width:auto; opacity:0.95; filter: saturate(1.1);}
    .header-center{flex:1;text-align:center}
    .title{font-weight:800;letter-spacing:1px;font-size:20px;margin:0;padding:0}
    .meta{font-size:13px;color:rgba(255,255,255,0.85);margin-top:6px}
    .submeta{font-size:12px;color:rgba(255,255,255,0.75);margin-top:4px}

    /* Boards */
    .boards{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px}
    .card{background:var(--card-bg);border-radius:10px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,10,0.35);display:flex;flex-direction:column;height:560px}
    .card-head{padding:10px 12px;color:#fff;font-weight:700;text-align:center}
    .card-body{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:6px 8px}
    table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:13px}
    thead th{padding:10px 8px;text-align:center;font-weight:700;color:white}
    tbody{display:block;width:100%;overflow:hidden}
    tbody tr{display:table;width:100%;table-layout:fixed}
    td{padding:10px 8px;text-align:center;border-bottom:1px solid rgba(16,22,26,0.05);vertical-align:middle;word-break:break-word}
    .col-rank{width:68px}
    .col-employee{width:320px;text-align:left;padding-left:12px}
    .col-prod{width:120px}
    .col-orders{width:100px}
    .col-avg{width:110px}

    /* row shading */
    tbody tr:nth-child(odd) td{background:var(--row-light)}
    tbody tr:nth-child(even) td{background:var(--row-dark)}

    /* medals */
    .medal-gold td{background:var(--gold);color:#000;font-weight:700}
    .medal-silver td{background:var(--silver);color:#000;font-weight:700}
    .medal-bronze td{background:var(--bronze);color:#000;font-weight:700}

    /* empty state */
    .empty{color:#8a8f98;padding:20px;text-align:center;font-style:italic}

    /* responsive */
    @media (max-width:1100px){.boards{grid-template-columns:1fr;}.col-employee{width:45vw} .card{height:520px}}

    /* subtle header badges */
    .badge{display:inline-block;padding:6px 12px;border-radius:6px;color:rgba(255,255,255,0.98);font-weight:700}

    /* scrolling controls */
    .scroll-wrapper{position:relative;flex:1;overflow:hidden}
    .scroll-content{position:absolute;left:0;right:0;top:0}
    .fade-top,.fade-bottom{position:absolute;left:0;right:0;height:36px;pointer-events:none}
    .fade-top{top:0;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0));}
    .fade-bottom{bottom:0;background:linear-gradient(0deg,rgba(255,255,255,0.98),rgba(255,255,255,0));}

    /* small helpers */
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header" role="banner">
      <div class="logo"><img src="rowecasa-logo.png" alt="Rowe Casa Logo" /></div>
      <div class="header-center">
        <div class="title">WEEKLY SHIPSTATION LEADERBOARD</div>
        <div id="weekRange" class="meta">Week: loading‚Ä¶</div>
        <div id="lastUpdated" class="submeta">Last Updated: ‚Äî</div>
      </div>
      <div style="width:56px"></div>
    </div>

    <div id="boards" class="boards" aria-live="polite" style="margin-top:18px"></div>
  </div>

<script>
(async function(){
  const SHEET_ID = '1HYfTADTvqpOMByLHcNPrgu8ahY58AZmdxaVgKbfQlMQ';
  const GID = '1113265790';
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

  // Robust CSV parser that handles quoted fields & commas
  function parseCSV(text){
    const rows = [];
    const lines = text.replace(/\r\n/g,'\n').split('\n');
    for(const line of lines){
      const row = [];
      let cur = '';
      let inQuotes = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"' ){
          if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; continue; }
          inQuotes = !inQuotes;
          continue;
        }
        if(ch === ',' && !inQuotes){
          row.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  // Fetch CSV
  async function fetchCSV(){
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error('Failed to load sheet ‚Äî make sure it is shared or published. Status: '+res.status);
    const txt = await res.text();
    return parseCSV(txt);
  }

  // Find week range and last updated - scan first 8 rows
  function findMeta(grid){
    for(let r=0;r<8 && r<grid.length;r++){
      const text = (grid[r] || []).join(' ').trim();
      if(!text) continue;
      if(/week[:\s]/i.test(text) || /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i.test(text)){
        return {row:r, text};
      }
    }
    return null;
  }
  function findLastUpdated(grid){
    for(let r=0;r<8 && r<grid.length;r++){
      const text = (grid[r] || []).join(' ').trim();
      if(/last updated/i.test(text)) return {row:r, text};
    }
    return null;
  }

  // Find every "Rank" header across the sheet (looking for cells equal to 'Rank' or 'Rank ')
  function findHeaderCells(grid){
    const headers = [];
    for(let r=0;r<20 && r<grid.length;r++){
      for(let c=0;c<(grid[r]||[]).length;c++){
        const cell = ((grid[r]||[])[c]||'').toString().trim().toLowerCase();
        if(cell === 'rank'){
          headers.push({row:r, col:c});
        }
      }
    }
    return headers;
  }

  // Extract block starting at header cell (col = rank column). Stop when employee cell blank for several rows
  function extractBlock(grid, header){
    const out = [];
    const startR = header.row + 1;
    const col = header.col;
    let empties = 0;
    for(let r=startR;r<grid.length;r++){
      const row = grid[r] || [];
      const rank = (row[col] || '').toString().trim();
      const employee = (row[col+1] || '').toString().trim();
      const products = (row[col+2] || '').toString().trim();
      const orders = (row[col+3] || '').toString().trim();
      const avg = (row[col+4] || '').toString().trim();
      if(!employee && !rank && !products && !orders && !avg){ empties++; if(empties>=3) break; else continue; }
      out.push({rank, employee, products, orders, avg});
    }
    return out;
  }

  // Beautify numbers
  function nice(x){ if(!x) return ''; const n = Number(x.toString().replace(/[,]/g,'')); return Number.isFinite(n) ? n.toLocaleString() : x; }

  // Build board card HTML
  function buildCard(title, color, rows){
    const head = `<div class="card-head" style="background:${color}">üèÜ ${title.toUpperCase()} üèÜ</div>`;
    if(!rows || rows.length===0) {
      return `<div class="card">${head}<div class="card-body"><div class="empty">No data for this week</div></div></div>`;
    }
    // create table html; tbody will be populated and used for scrolling
    const rowsHtml = rows.map((r,idx)=>{
      const cls = idx===0? 'medal-gold' : idx===1? 'medal-silver' : idx===2? 'medal-bronze' : '';
      return `<tr class="${cls}"><td class="col-rank">${r.rank||''}</td><td class="col-employee">${r.employee||''}</td><td class="col-prod">${nice(r.products)}</td><td class="col-orders">${nice(r.orders)}</td><td class="col-avg">${r.avg||''}</td></tr>`;
    }).join('');
    return `
      <div class="card">
        ${head}
        <div class="card-body">
          <div style="overflow:hidden;flex:1;display:flex;flex-direction:column">
            <table aria-label="${title} leaderboard">
              <thead><tr><th class="col-rank">Rank</th><th class="col-employee">Employee</th><th class="col-prod">Products</th><th class="col-orders">Orders</th><th class="col-avg">Avg/Order</th></tr></thead>
            </table>
            <div class="scroll-wrapper" data-rows="${rows.length}" style="flex:1;position:relative">
              <div class="scroll-content" role="list" aria-label="${title} entries">
                <table><tbody>${rowsHtml}</tbody></table>
                <!-- duplicate for seamless scroll if needed via JS -->
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  try{
    const raw = await fetchCSV();
    // get meta
    const meta = findMeta(raw);
    if(meta) document.getElementById('weekRange').textContent = meta.text.replace(/\s{2,}/g,' ').trim();
    const lu = findLastUpdated(raw);
    if(lu) document.getElementById('lastUpdated').textContent = lu.text.replace(/\s{2,}/g,' ').trim();

    // find all 'rank' headers
    const headerCells = findHeaderCells(raw);
    // If fewer than 3 headers found, try to find "Full-time" titles and their following header row
    if(headerCells.length < 3){
      // attempt to search for text 'full-time' etc and then next row has 'Rank'
      const labels = ['full-time','part-time','wholesale'];
      for(let r=0;r<12 && headerCells.length<3;r++){
        for(let c=0;c<(raw[r]||[]).length;c++){
          const cell = ((raw[r]||[])[c]||'').toString().trim().toLowerCase();
          if(labels.includes(cell)){
            // look for 'rank' in the next few rows same columns
            if(((raw[r+1]||[])[c]||'').toString().trim().toLowerCase() === 'rank'){
              headerCells.push({row:r+1, col:c});
            } else {
              // try searching nearby columns
              for(let cc=c; cc<c+6 && cc < (raw[r+1]||[]).length; cc++){
                if(((raw[r+1]||[])[cc]||'').toString().trim().toLowerCase() === 'rank'){
                  headerCells.push({row:r+1, col:cc});
                }
              }
            }
          }
        }
      }
    }

    // Sort headers left-to-right by column index and take first three
    headerCells.sort((a,b)=>a.col - b.col);
    const chosen = headerCells.slice(0,3);

    // Titles and colors
    const cats = ['Full-time','Part-Time','Wholesale'];
    const cols = {'Full-time':'var(--ft)','Part-Time':'var(--pt)','Wholesale':'var(--wh)'};

    const boardsEl = document.getElementById('boards');
    boardsEl.innerHTML = '';

    for(let i=0;i<3;i++){
      const h = chosen[i];
      let rows = [];
      if(h) rows = extractBlock(raw, h);
      boardsEl.insertAdjacentHTML('beforeend', buildCard(cats[i], cols[cats[i]], rows));
    }

    // Now set up smooth auto-scroll for each card's scroll-wrapper
    document.querySelectorAll('.scroll-wrapper').forEach(wrapper=>{
      const content = wrapper.querySelector('.scroll-content');
      const tbody = content.querySelector('tbody');
      // measure heights
      // make content absolute and duplicated if needed for seamless scroll
      // first, if content height less than wrapper, do nothing
      // else duplicate and animate via JS
      setTimeout(()=>{
        const contentHeight = content.scrollHeight;
        const wrapH = wrapper.clientHeight;
        if(contentHeight > wrapH){
          // duplicate inner HTML to create loop
          content.innerHTML = content.innerHTML + content.innerHTML;
          let pos = 0;
          let direction = 1; // scroll down
          const speed = 30; // px per second
          let rafId = null;
          let last = performance.now();
          function step(now){
            const delta = now - last;
            last = now;
            pos += (speed * delta / 1000) * direction;
            // when pos exceeds half of content (we duplicated) reset
            const limit = content.scrollHeight/2;
            if(pos >= limit) pos = 0;
            content.style.transform = `translateY(${-pos}px)`;
            rafId = requestAnimationFrame(step);
          }
          rafId = requestAnimationFrame(step);
          // pause on hover
          wrapper.addEventListener('mouseenter', ()=>{ if(rafId) cancelAnimationFrame(rafId); rafId = null; });
          wrapper.addEventListener('mouseleave', ()=>{ if(!rafId){ last = performance.now(); rafId = requestAnimationFrame(step); } });
        } else {
          // center if short
          content.style.top = '0';
        }
      },120);
    });

  } catch (err){
    console.error(err);
    const boardsEl = document.getElementById('boards');
    boardsEl.innerHTML = `<div style="grid-column:1/-1;padding:18px;border-radius:8px;background:rgba(255,255,255,0.06);color:#fff">Error loading data: ${err.message}. Make sure the spreadsheet is published or "Anyone with the link" can view it.</div>`;
  }
})();
</script>
</body>
</html>
